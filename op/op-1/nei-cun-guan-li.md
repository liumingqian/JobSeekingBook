# 内存管理

ref:[虚拟内存与物理内存的联系与区别](https://blog.csdn.net/lvyibin890/article/details/82217193)

### 内存管理的功能

* 内存分配与回收
* 地址转换：多道程序环境下，逻辑地址与内存中物理地址不可能一致，存储管理必须提供地址变换功能，把逻辑地址转换为物理地址
* 用虚拟内存等技术从逻辑上扩充内存
* 存储保护：保证作业和操作系统在各自的存储空间内运行互不干扰

### 虚拟内存

程序在物理地址中寻址的范围与机器字长有关，在32位平台下，寻址的范围是2^32=4G。虚拟内存的好处：如果没有虚拟内存，每次开启一个进程都分配4G物理内存给它就很没效率，并且我们不希望程序指令可以直接访问物理内存。因此每个进程运行的时候会得到4G虚拟内存，但实际虚拟内存可能只对应一点物理内存，实际用了多少内存就会对应多少物理内存。从进程的角度看，它拥有4G连续的地址空间，实际上是被分隔成多个物理内存碎片，还有一部分碎片存储在外部磁盘，在需要时进行数据交换。这样物理内存就不需要是连续的了。

* 逻辑地址：开发人员能看到的地址，当链接程序将各个模块链接成一个完整的可执行目标程序时，链接程序顺序依次按各个模块的相对地址构成统一的从0号单元开始编址的逻辑地址空间。如，创建数组时，操作系统会返回一个逻辑上的连续空间。但逻辑地址和元素存储的真实地址不相干，是操作系统通过地址映射成连续的，是相对于你当前进程数据段的地址（偏移地址）。
* 物理地址：加载到内存中的地址，内存单元的真正地址，在总线上传输使用物理地址，不必转换，不必分页。

#### 虚拟内存技术的特点

* 从逻辑上扩充内存：物理内存不需要是连续的了
* 用时间换空间
* 安全：保护操作系统不受用户进程影响，保护用户进程间不会相互影响。

#### 内存寻址

* 重定位寄存器：保存最小的物理地址
* 界地址寄存器：保存最大的逻辑地址（根据程序的长度）

当进程读取内存时，CPU硬件在把地址发送到内存总线前，首先跟界地址寄存器里的值进行比较以防内存越界，然后自动把重定位寄存器里的值加到进程地址值上，将其映射为了物理地址。

> 当进程访问地址时发生了什么？
>
> 1、将逻辑地址翻译为实际的物理内存地址
>
> 2、通过页表来记录哪些地址空间上的数据是在物理内存上，哪些实际上存在磁盘上。
>
> 3、当进程访问虚拟地址的时候会先看页表，如果发现对应的数据不在物理内存上，就会发生缺页异常。
>
> 4、缺页异常的处理方法是，操作系统阻塞该进程，并将硬盘里对应的页换入内存，并使该进程就绪。如果内存已经满了，根据页面置换算法找到一个页进行覆盖。

### 程序装入和链接

创建进程首先要将程序和数据装入内存。将用户源程序变为可在内存中执行的程序：

* 编译：由编译程序将用户源代码编译成若干个目标模块。
* 链接：由链接程序将编译后形成的一组目标模块，以及所需库函数链接在一起，形成一个完整的装入模块。
* 装入：由装入程序将装入模块装入内存运行。

![](../../.gitbook/assets/image%20%288%29.png)

#### 程序的链接有以下三种方式：

* 静态链接：在程序运行之前，先将各目标模块及它们所需的库函数链接成一个完整的可执行程序，以后不再拆开。
* 装入时动态链接：将用户源程序编译后所得到的一组目标模块，在装入内存时，釆用边装入边链接的链接方式。
* 运行时动态链接：对某些目标模块的链接，是在程序执行中需要该目标模块时，才对它进行的链接。其优点是便于修改和更新，便于实现对目标模块的共享。

#### 内存的装入模块在装入内存时有以下三种方式：

* 绝对装入。在编译时，如果知道程序将驻留在内存的某个位置，编译程序将产生绝对地址的目标代码。绝对装入程序按照装入模块中的地址，将程序和数据装入内存。由于程序中的逻辑地址与实际内存地址完全相同，故不需对程序和数据的地址进行修改。 绝对装入方式_只适用于单道程序环境_。另外，程序中所使用的绝对地址,可在编译或汇编时给出，也可由程序员直接赋予。而通常情况下在程序中釆用的是符号地址，编译或汇编时再转换为绝对地址。
* 静态重定位装入。在多道程序环境下，多个目标模块的起始地址通常都是从0开始，程序中的其他地址都是相对于起始地址的,此时应釆用可重定位装入方式。根据内存的当前情况，将装入模块装入到内存的适当位置。装入时对目标程序中指令和数据的修改过程称为**重定位**，地址变换通常是在装入时一次完成的，所以又称为静态重定位。静态重定位在一个作业装入内存时，必须分配其要求的全部内存空间，如果没有足够的内存，就不能装入该作业。作业一旦进入内存后，在整个运行期间不能在内存中移动，也不能再申请内存空间。
* 动态运行时装入，也称为动态重定位，程序在内存中如果发生移动，就需要釆用动态的装入方式。把装入模块装入内存后，并不立即把装入模块中的相对地址转换为绝对地址，而把地址转换推迟到程序真正执行时进行。因此装入内存后的所有地址均为相对地址。这种方式需要一个重定位寄存器的支持。动态重定位的特点是可以_将程序分配到不连续的存储区中_；在程序运行之前可以只装入它的部分代码即可投入运行，然后在程序运行期间，根据需要动态申请分配内存；便于程序段的共享，可以向用户提供一个比存储空间大得多的地址空间。

### 分页内存管理

使进程的物理地址空间可以是非连续的。

物理内存被划分为很多小块，每块被称为帧，分配内存时帧是最小单位。逻辑内存中与帧对应的概念是页。

## 页表

页表是虚拟内存系统用来存储逻辑地址和物理地址之间映射的数据结构

